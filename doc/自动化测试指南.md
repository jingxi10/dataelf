# æ•°æµç²¾çµ - è‡ªåŠ¨åŒ–æµ‹è¯•æŒ‡å—

**ç‰ˆæœ¬**: 1.0.0  
**æ›´æ–°æ—¥æœŸ**: 2024-12-20

---

## ğŸ“‹ æµ‹è¯•æ¡†æ¶é€‰æ‹©

### åç«¯æµ‹è¯•
- **å•å…ƒæµ‹è¯•**: JUnit 5 + Mockito
- **é›†æˆæµ‹è¯•**: Spring Boot Test
- **APIæµ‹è¯•**: REST Assured
- **æ€§èƒ½æµ‹è¯•**: JMeter

### å‰ç«¯æµ‹è¯•
- **å•å…ƒæµ‹è¯•**: Vitest
- **ç»„ä»¶æµ‹è¯•**: Vue Test Utils
- **E2Eæµ‹è¯•**: Cypress
- **æ€§èƒ½æµ‹è¯•**: Lighthouse

---

## ğŸ§ª åç«¯æµ‹è¯•

### 1. å•å…ƒæµ‹è¯•ç¤ºä¾‹

#### DataSourceServiceTest.java
```java
package com.dataelf.platform.service;

import com.dataelf.platform.dto.DataSourceCreateRequest;
import com.dataelf.platform.dto.DataSourceDTO;
import com.dataelf.platform.entity.DataSource;
import com.dataelf.platform.repository.DataSourceRepository;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;

import java.util.Optional;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.*;

@ExtendWith(MockitoExtension.class)
class DataSourceServiceTest {
    
    @Mock
    private DataSourceRepository dataSourceRepository;
    
    @InjectMocks
    private DataSourceService dataSourceService;
    
    @Test
    void testCreateDataSource() {
        // Given
        DataSourceCreateRequest request = new DataSourceCreateRequest();
        request.setName("Test Source");
        request.setUrl("https://example.com/feed");
        request.setSourceType(DataSource.SourceType.RSS);
        request.setFetchInterval(24);
        
        DataSource savedDataSource = new DataSource();
        savedDataSource.setId(1L);
        savedDataSource.setName("Test Source");
        
        when(dataSourceRepository.save(any(DataSource.class)))
            .thenReturn(savedDataSource);
        
        // When
        DataSourceDTO result = dataSourceService.createDataSource(request);
        
        // Then
        assertNotNull(result);
        assertEquals("Test Source", result.getName());
        verify(dataSourceRepository, times(1)).save(any(DataSource.class));
    }
    
    @Test
    void testGetDataSource() {
        // Given
        Long id = 1L;
        DataSource dataSource = new DataSource();
        dataSource.setId(id);
        dataSource.setName("Test Source");
        
        when(dataSourceRepository.findById(id))
            .thenReturn(Optional.of(dataSource));
        
        // When
        DataSourceDTO result = dataSourceService.getDataSource(id);
        
        // Then
        assertNotNull(result);
        assertEquals(id, result.getId());
        assertEquals("Test Source", result.getName());
    }
    
    @Test
    void testDeleteDataSource() {
        // Given
        Long id = 1L;
        DataSource dataSource = new DataSource();
        dataSource.setId(id);
        
        when(dataSourceRepository.findById(id))
            .thenReturn(Optional.of(dataSource));
        
        // When
        dataSourceService.deleteDataSource(id);
        
        // Then
        verify(dataSourceRepository, times(1)).delete(dataSource);
    }
}
```

### 2. é›†æˆæµ‹è¯•ç¤ºä¾‹

#### DataSourceControllerIntegrationTest.java
```java
package com.dataelf.platform.controller;

import com.dataelf.platform.dto.DataSourceCreateRequest;
import com.dataelf.platform.entity.DataSource;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.http.MediaType;
import org.springframework.security.test.context.support.WithMockUser;
import org.springframework.test.web.servlet.MockMvc;

import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;

@SpringBootTest
@AutoConfigureMockMvc
class DataSourceControllerIntegrationTest {
    
    @Autowired
    private MockMvc mockMvc;
    
    @Test
    @WithMockUser(roles = "ADMIN")
    void testCreateDataSource() throws Exception {
        String requestBody = """
            {
                "name": "Test Source",
                "url": "https://example.com/feed",
                "sourceType": "RSS",
                "fetchInterval": 24
            }
            """;
        
        mockMvc.perform(post("/api/admin/data-sources")
                .contentType(MediaType.APPLICATION_JSON)
                .content(requestBody))
                .andExpect(status().isCreated())
                .andExpect(jsonPath("$.success").value(true))
                .andExpect(jsonPath("$.data.name").value("Test Source"));
    }
    
    @Test
    @WithMockUser(roles = "ADMIN")
    void testGetAllDataSources() throws Exception {
        mockMvc.perform(get("/api/admin/data-sources"))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.success").value(true))
                .andExpect(jsonPath("$.data").isArray());
    }
    
    @Test
    @WithMockUser(roles = "USER")
    void testUnauthorizedAccess() throws Exception {
        mockMvc.perform(get("/api/admin/data-sources"))
                .andExpect(status().isForbidden());
    }
}
```

### 3. APIæµ‹è¯•ç¤ºä¾‹

#### DataSourceAPITest.java
```java
package com.dataelf.platform.api;

import io.restassured.RestAssured;
import io.restassured.http.ContentType;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.web.server.LocalServerPort;

import static io.restassured.RestAssured.*;
import static org.hamcrest.Matchers.*;

@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
class DataSourceAPITest {
    
    @LocalServerPort
    private int port;
    
    private String adminToken;
    
    @BeforeEach
    void setUp() {
        RestAssured.port = port;
        // è·å–ç®¡ç†å‘˜Token
        adminToken = getAdminToken();
    }
    
    @Test
    void testCreateDataSource() {
        given()
            .header("Authorization", "Bearer " + adminToken)
            .contentType(ContentType.JSON)
            .body("""
                {
                    "name": "Test Source",
                    "url": "https://example.com/feed",
                    "sourceType": "RSS",
                    "fetchInterval": 24
                }
                """)
        .when()
            .post("/api/admin/data-sources")
        .then()
            .statusCode(201)
            .body("success", equalTo(true))
            .body("data.name", equalTo("Test Source"));
    }
    
    @Test
    void testGetDataSources() {
        given()
            .header("Authorization", "Bearer " + adminToken)
        .when()
            .get("/api/admin/data-sources")
        .then()
            .statusCode(200)
            .body("success", equalTo(true))
            .body("data", notNullValue());
    }
    
    private String getAdminToken() {
        // å®ç°è·å–Tokençš„é€»è¾‘
        return "mock-admin-token";
    }
}
```

---

## ğŸ¨ å‰ç«¯æµ‹è¯•

### 1. ç»„ä»¶å•å…ƒæµ‹è¯•

#### TagCloud.spec.js
```javascript
import { describe, it, expect, vi } from 'vitest'
import { mount } from '@vue/test-utils'
import TagCloud from '@/components/TagCloud.vue'
import { getPopularTags } from '@/api/tag'

vi.mock('@/api/tag')

describe('TagCloud', () => {
  it('renders tags correctly', async () => {
    const mockTags = [
      { id: 1, name: 'Vue', usageCount: 50 },
      { id: 2, name: 'React', usageCount: 30 },
      { id: 3, name: 'Angular', usageCount: 10 }
    ]
    
    getPopularTags.mockResolvedValue({
      data: { success: true, data: mockTags }
    })
    
    const wrapper = mount(TagCloud, {
      props: { mode: 'popular', maxTags: 10 }
    })
    
    await wrapper.vm.$nextTick()
    await new Promise(resolve => setTimeout(resolve, 100))
    
    expect(wrapper.findAll('.tag-item')).toHaveLength(3)
    expect(wrapper.text()).toContain('Vue')
    expect(wrapper.text()).toContain('React')
  })
  
  it('emits tag-click event when tag is clicked', async () => {
    const mockTags = [
      { id: 1, name: 'Vue', usageCount: 50 }
    ]
    
    getPopularTags.mockResolvedValue({
      data: { success: true, data: mockTags }
    })
    
    const wrapper = mount(TagCloud, {
      props: { clickable: true }
    })
    
    await wrapper.vm.$nextTick()
    await new Promise(resolve => setTimeout(resolve, 100))
    
    await wrapper.find('.tag-item').trigger('click')
    
    expect(wrapper.emitted('tag-click')).toBeTruthy()
    expect(wrapper.emitted('tag-click')[0][0]).toEqual(mockTags[0])
  })
  
  it('applies correct size based on usage count', () => {
    const wrapper = mount(TagCloud)
    
    expect(wrapper.vm.getTagSize(60)).toBe('large')
    expect(wrapper.vm.getTagSize(25)).toBe('default')
    expect(wrapper.vm.getTagSize(5)).toBe('small')
  })
})
```

### 2. E2Eæµ‹è¯•ç¤ºä¾‹

#### dataSource.cy.js
```javascript
describe('Data Source Management', () => {
  beforeEach(() => {
    // ç™»å½•ç®¡ç†å‘˜è´¦å·
    cy.login('admin@example.com', 'password')
    cy.visit('/admin/data-sources')
  })
  
  it('should display data sources list', () => {
    cy.get('.list-card').should('be.visible')
    cy.get('el-table').should('exist')
  })
  
  it('should create a new data source', () => {
    cy.get('button').contains('æ·»åŠ æ•°æ®æº').click()
    
    cy.get('input[placeholder="è¯·è¾“å…¥æ•°æ®æºåç§°"]')
      .type('Test RSS Feed')
    
    cy.get('input[placeholder="è¯·è¾“å…¥æ•°æ®æºURL"]')
      .type('https://example.com/feed.xml')
    
    cy.get('.el-select').click()
    cy.get('.el-select-dropdown__item').contains('RSS').click()
    
    cy.get('.el-input-number input').clear().type('24')
    
    cy.get('button').contains('åˆ›å»º').click()
    
    cy.get('.el-message').should('contain', 'æ•°æ®æºåˆ›å»ºæˆåŠŸ')
    cy.get('el-table').should('contain', 'Test RSS Feed')
  })
  
  it('should edit a data source', () => {
    cy.get('el-table tbody tr').first().within(() => {
      cy.get('button').contains('ç¼–è¾‘').click()
    })
    
    cy.get('input[placeholder="è¯·è¾“å…¥æ•°æ®æºåç§°"]')
      .clear()
      .type('Updated Name')
    
    cy.get('button').contains('æ›´æ–°').click()
    
    cy.get('.el-message').should('contain', 'æ•°æ®æºæ›´æ–°æˆåŠŸ')
    cy.get('el-table').should('contain', 'Updated Name')
  })
  
  it('should trigger manual fetch', () => {
    cy.get('el-table tbody tr').first().within(() => {
      cy.get('button').contains('æŠ“å–').click()
    })
    
    cy.get('.el-message').should('contain', 'æŠ“å–ä»»åŠ¡å·²è§¦å‘')
  })
  
  it('should delete a data source', () => {
    cy.get('el-table tbody tr').first().within(() => {
      cy.get('button').contains('åˆ é™¤').click()
    })
    
    cy.get('.el-message-box').within(() => {
      cy.get('button').contains('ç¡®å®š').click()
    })
    
    cy.get('.el-message').should('contain', 'æ•°æ®æºåˆ é™¤æˆåŠŸ')
  })
})
```

### 3. API Mockæµ‹è¯•

#### setupTests.js
```javascript
import { vi } from 'vitest'
import { config } from '@vue/test-utils'

// Mock Element Plus
config.global.stubs = {
  'el-button': true,
  'el-input': true,
  'el-table': true,
  'el-dialog': true
}

// Mock API
vi.mock('@/api/dataSource', () => ({
  getAllDataSources: vi.fn(() => Promise.resolve({
    data: {
      success: true,
      data: []
    }
  })),
  createDataSource: vi.fn(() => Promise.resolve({
    data: {
      success: true,
      data: { id: 1, name: 'Test' }
    }
  })),
  updateDataSource: vi.fn(() => Promise.resolve({
    data: {
      success: true,
      data: { id: 1, name: 'Updated' }
    }
  })),
  deleteDataSource: vi.fn(() => Promise.resolve({
    data: {
      success: true
    }
  }))
}))
```

---

## ğŸš€ è¿è¡Œæµ‹è¯•

### åç«¯æµ‹è¯•

#### è¿è¡Œæ‰€æœ‰æµ‹è¯•
```bash
cd backend
mvn test
```

#### è¿è¡Œç‰¹å®šæµ‹è¯•ç±»
```bash
mvn test -Dtest=DataSourceServiceTest
```

#### ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
```bash
mvn test jacoco:report
```

### å‰ç«¯æµ‹è¯•

#### è¿è¡Œå•å…ƒæµ‹è¯•
```bash
cd frontend
npm run test:unit
```

#### è¿è¡ŒE2Eæµ‹è¯•
```bash
npm run test:e2e
```

#### ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
```bash
npm run test:coverage
```

---

## ğŸ“Š æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

### åç«¯
- **å•å…ƒæµ‹è¯•è¦†ç›–ç‡**: > 80%
- **é›†æˆæµ‹è¯•è¦†ç›–ç‡**: > 60%
- **APIæµ‹è¯•è¦†ç›–ç‡**: 100%

### å‰ç«¯
- **ç»„ä»¶æµ‹è¯•è¦†ç›–ç‡**: > 70%
- **å·¥å…·å‡½æ•°è¦†ç›–ç‡**: > 90%
- **E2Eæµ‹è¯•è¦†ç›–ç‡**: æ ¸å¿ƒæµç¨‹100%

---

## ğŸ”„ æŒç»­é›†æˆ

### GitHub Actionsé…ç½®

#### .github/workflows/test.yml
```yaml
name: Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  backend-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Set up JDK 17
        uses: actions/setup-java@v2
        with:
          java-version: '17'
          distribution: 'adopt'
      
      - name: Run tests
        run: |
          cd backend
          mvn clean test
      
      - name: Generate coverage report
        run: |
          cd backend
          mvn jacoco:report
      
      - name: Upload coverage
        uses: codecov/codecov-action@v2
        with:
          files: ./backend/target/site/jacoco/jacoco.xml

  frontend-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Run tests
        run: |
          cd frontend
          npm run test:unit
      
      - name: Run E2E tests
        run: |
          cd frontend
          npm run test:e2e:ci
      
      - name: Upload coverage
        uses: codecov/codecov-action@v2
        with:
          files: ./frontend/coverage/lcov.info
```

---

## ğŸ“ æµ‹è¯•æœ€ä½³å®è·µ

### 1. æµ‹è¯•å‘½å
- ä½¿ç”¨æè¿°æ€§çš„æµ‹è¯•åç§°
- éµå¾ª `should_ExpectedBehavior_When_StateUnderTest` æ ¼å¼
- ä¾‹å¦‚: `should_ReturnError_When_DataSourceNotFound`

### 2. æµ‹è¯•ç»“æ„
- ä½¿ç”¨ Given-When-Then æ¨¡å¼
- Given: è®¾ç½®æµ‹è¯•å‰ç½®æ¡ä»¶
- When: æ‰§è¡Œè¢«æµ‹è¯•çš„æ“ä½œ
- Then: éªŒè¯ç»“æœ

### 3. æµ‹è¯•éš”ç¦»
- æ¯ä¸ªæµ‹è¯•åº”è¯¥ç‹¬ç«‹è¿è¡Œ
- ä¸ä¾èµ–å…¶ä»–æµ‹è¯•çš„ç»“æœ
- ä½¿ç”¨ @BeforeEach å’Œ @AfterEach æ¸…ç†çŠ¶æ€

### 4. Mockä½¿ç”¨
- åªMockå¤–éƒ¨ä¾èµ–
- ä¸è¦è¿‡åº¦Mock
- ä½¿ç”¨çœŸå®å¯¹è±¡è¿›è¡Œé›†æˆæµ‹è¯•

### 5. æ–­è¨€æ¸…æ™°
- æ¯ä¸ªæµ‹è¯•åªéªŒè¯ä¸€ä¸ªè¡Œä¸º
- ä½¿ç”¨æ¸…æ™°çš„æ–­è¨€æ¶ˆæ¯
- é¿å…è¿‡å¤šçš„æ–­è¨€

---

## ğŸ¯ æµ‹è¯•æ£€æŸ¥æ¸…å•

### å¼€å‘é˜¶æ®µ
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•
- [ ] ç¼–å†™é›†æˆæµ‹è¯•
- [ ] æœ¬åœ°è¿è¡Œæµ‹è¯•
- [ ] æ£€æŸ¥æµ‹è¯•è¦†ç›–ç‡

### æäº¤å‰
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] è¦†ç›–ç‡è¾¾æ ‡
- [ ] ä»£ç å®¡æŸ¥
- [ ] æ›´æ–°æ–‡æ¡£

### éƒ¨ç½²å‰
- [ ] è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
- [ ] è¿è¡ŒE2Eæµ‹è¯•
- [ ] æ€§èƒ½æµ‹è¯•
- [ ] å®‰å…¨æµ‹è¯•

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0  
**æœ€åæ›´æ–°**: 2024-12-20  
**ç»´æŠ¤å›¢é˜Ÿ**: æ•°æµç²¾çµæµ‹è¯•å›¢é˜Ÿ
