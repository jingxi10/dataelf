# 数据源管理实现说明

## 功能概述

实现了完整的数据源管理系统，支持添加、管理多个外部数据源，配置定时抓取任务，以及数据清洗和模板映射功能。

## 核心特性

### 1. 数据源管理
- **添加数据源**: 支持多种数据源类型（RSS、HTML、API、JSON、XML）
- **编辑数据源**: 修改数据源配置
- **删除数据源**: 删除不需要的数据源
- **启用/禁用**: 灵活控制数据源状态

### 2. 抓取配置
- **定时抓取**: 配置抓取间隔（1-168小时）
- **手动触发**: 支持手动触发立即抓取
- **抓取统计**: 记录抓取次数、成功次数、失败次数
- **错误追踪**: 记录最后一次错误信息

### 3. 高级配置
- **选择器配置**: JSON格式配置数据提取规则
- **清洗规则**: JSON格式配置数据清洗规则
- **模板映射**: JSON格式配置数据到模板的映射关系

### 4. 状态管理
- **ACTIVE**: 活跃状态，正常抓取
- **PAUSED**: 暂停状态，临时停止抓取
- **ERROR**: 错误状态，抓取失败
- **DISABLED**: 禁用状态，完全停止

## 技术实现

### 后端实现

#### 1. 实体类 (DataSource.java)
```java
@Entity
@Table(name = "data_sources")
public class DataSource {
    private Long id;
    private String name;              // 数据源名称
    private String url;               // 数据源URL
    private String description;       // 描述
    private SourceType sourceType;    // 类型（RSS/HTML/API/JSON/XML）
    private SourceStatus status;      // 状态
    private Integer fetchInterval;    // 抓取间隔（小时）
    private LocalDateTime lastFetchTime;    // 最后抓取时间
    private LocalDateTime nextFetchTime;    // 下次抓取时间
    private Integer fetchCount;       // 抓取次数
    private Integer successCount;     // 成功次数
    private Integer errorCount;       // 失败次数
    private String lastError;         // 最后错误
    private String selectorConfig;    // 选择器配置（JSON）
    private String cleaningRules;     // 清洗规则（JSON）
    private String templateMapping;   // 模板映射（JSON）
    private Boolean enabled;          // 是否启用
}
```

#### 2. 服务层 (DataSourceService.java)
**核心方法**:
- `createDataSource()`: 创建数据源
- `getAllDataSources()`: 获取所有数据源
- `getEnabledDataSources()`: 获取启用的数据源
- `updateDataSource()`: 更新数据源
- `deleteDataSource()`: 删除数据源
- `toggleDataSource()`: 启用/禁用数据源
- `triggerFetch()`: 手动触发抓取
- `getDataSourcesNeedingFetch()`: 获取需要抓取的数据源
- `updateFetchResult()`: 更新抓取结果

#### 3. 控制器 (DataSourceController.java)
**API端点** (所有端点需要管理员权限):
```
GET    /api/admin/data-sources           - 获取所有数据源
GET    /api/admin/data-sources/enabled   - 获取启用的数据源
GET    /api/admin/data-sources/{id}      - 获取指定数据源
POST   /api/admin/data-sources           - 创建数据源
PUT    /api/admin/data-sources/{id}      - 更新数据源
DELETE /api/admin/data-sources/{id}      - 删除数据源
PATCH  /api/admin/data-sources/{id}/toggle - 启用/禁用数据源
POST   /api/admin/data-sources/{id}/fetch  - 手动触发抓取
```

### 前端实现

#### 1. 数据源管理页面 (DataSourceManagement.vue)
**位置**: `frontend/src/views/admin/DataSourceManagement.vue`

**功能模块**:

1. **操作栏**:
   - 添加数据源按钮
   - 刷新按钮
   - 数据源总数显示

2. **数据源列表**:
   - 表格展示所有数据源
   - 显示ID、名称、类型、状态、抓取间隔
   - 显示抓取统计（总次数、成功、失败）
   - 显示最后抓取时间
   - 操作按钮（查看、编辑、抓取、启用/禁用、删除）

3. **创建/编辑对话框**:
   - 基本信息（名称、URL、类型、间隔、描述）
   - 高级配置（选择器、清洗规则、模板映射）
   - 表单验证

4. **详情抽屉**:
   - 完整的数据源信息
   - 抓取统计
   - 错误信息（如有）
   - 操作按钮

#### 2. API接口 (dataSource.js)
**位置**: `frontend/src/api/dataSource.js`

**方法**:
```javascript
getAllDataSources()           // 获取所有数据源
getEnabledDataSources()       // 获取启用的数据源
getDataSource(id)             // 获取指定数据源
createDataSource(data)        // 创建数据源
updateDataSource(id, data)    // 更新数据源
deleteDataSource(id)          // 删除数据源
toggleDataSource(id, enabled) // 启用/禁用数据源
triggerFetch(id)              // 手动触发抓取
```

## 使用说明

### 管理员操作

#### 1. 访问数据源管理
1. 登录管理员账号
2. 进入管理后台
3. 点击左侧菜单"数据源管理"

#### 2. 添加数据源

##### 基本配置
1. 点击"添加数据源"按钮
2. 填写基本信息:
   - **数据源名称**: 便于识别的名称
   - **数据源URL**: 数据源的完整URL
   - **数据源类型**: 选择合适的类型
   - **抓取间隔**: 设置抓取频率（1-168小时）
   - **描述**: 可选的详细说明

##### 高级配置（可选）

**选择器配置** (JSON格式):
```json
{
  "title": ".article-title",
  "content": ".article-content",
  "author": ".author-name",
  "publishDate": ".publish-date"
}
```

**清洗规则** (JSON格式):
```json
{
  "removeHtml": true,
  "trimSpaces": true,
  "removeEmptyLines": true,
  "maxLength": 5000
}
```

**模板映射** (JSON格式):
```json
{
  "templateType": "TECH_ARTICLE",
  "fields": {
    "title": "title",
    "content": "content",
    "author": "author"
  }
}
```

3. 点击"创建"

#### 3. 编辑数据源
1. 在列表中找到要编辑的数据源
2. 点击"编辑"按钮
3. 修改配置信息
4. 点击"更新"

#### 4. 查看数据源详情
1. 点击"查看"按钮
2. 在抽屉中查看完整信息:
   - 基本信息
   - 抓取统计
   - 时间信息
   - 错误信息（如有）

#### 5. 手动触发抓取
1. 确保数据源已启用
2. 点击"抓取"按钮
3. 系统立即触发抓取任务

**注意**: 禁用的数据源无法触发抓取

#### 6. 启用/禁用数据源
1. 点击"启用"或"禁用"按钮
2. 禁用后数据源停止自动抓取
3. 启用后恢复自动抓取

#### 7. 删除数据源
1. 点击"删除"按钮
2. 确认删除操作
3. 数据源及其配置被永久删除

## 数据源类型说明

### 1. RSS订阅
- **适用场景**: 博客、新闻网站的RSS feed
- **URL示例**: `https://example.com/feed.xml`
- **特点**: 标准化格式，易于解析

### 2. HTML网页
- **适用场景**: 普通网页内容抓取
- **URL示例**: `https://example.com/articles`
- **特点**: 需要配置选择器提取内容

### 3. API接口
- **适用场景**: RESTful API数据源
- **URL示例**: `https://api.example.com/v1/articles`
- **特点**: 结构化数据，易于处理

### 4. JSON数据
- **适用场景**: JSON格式的数据文件
- **URL示例**: `https://example.com/data.json`
- **特点**: 直接解析JSON

### 5. XML数据
- **适用场景**: XML格式的数据文件
- **URL示例**: `https://example.com/data.xml`
- **特点**: 需要XML解析器

## 抓取间隔建议

| 数据源类型 | 建议间隔 | 说明 |
|-----------|---------|------|
| 新闻网站 | 1-6小时 | 更新频繁 |
| 博客 | 12-24小时 | 更新较慢 |
| 学术期刊 | 24-168小时 | 更新很慢 |
| API接口 | 根据限制 | 遵守API限流 |

## 数据库设计

### data_sources表结构
```sql
CREATE TABLE data_sources (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(200) NOT NULL,
    url VARCHAR(500) NOT NULL,
    description VARCHAR(1000),
    source_type VARCHAR(20) NOT NULL,
    status VARCHAR(20) NOT NULL,
    fetch_interval INT NOT NULL,
    last_fetch_time TIMESTAMP,
    next_fetch_time TIMESTAMP,
    fetch_count INT DEFAULT 0,
    success_count INT DEFAULT 0,
    error_count INT DEFAULT 0,
    last_error VARCHAR(1000),
    selector_config TEXT,
    cleaning_rules TEXT,
    template_mapping TEXT,
    enabled BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

## 路由配置

### 管理后台路由
```javascript
{
  path: 'data-sources',
  name: 'admin-data-sources',
  component: () => import('@/views/admin/DataSourceManagement.vue'),
  meta: { title: '数据源管理' }
}
```

### 菜单配置
在 `AdminLayout.vue` 中添加菜单项：
```vue
<el-menu-item index="/admin/data-sources">
  <el-icon><Connection /></el-icon>
  <span>数据源管理</span>
</el-menu-item>
```

## 定时任务（待实现）

### 抓取调度器
```java
@Scheduled(fixedDelay = 3600000) // 每小时检查一次
public void scheduleFetch() {
    List<DataSource> sources = dataSourceService.getDataSourcesNeedingFetch();
    for (DataSource source : sources) {
        try {
            // 执行抓取逻辑
            fetchData(source);
            dataSourceService.updateFetchResult(source.getId(), true, null);
        } catch (Exception e) {
            dataSourceService.updateFetchResult(source.getId(), false, e.getMessage());
        }
    }
}
```

## 测试建议

### 功能测试
1. **创建数据源**:
   - 创建不同类型的数据源
   - 验证URL格式
   - 验证抓取间隔范围

2. **编辑数据源**:
   - 修改基本信息
   - 修改高级配置
   - 验证更新生效

3. **抓取功能**:
   - 手动触发抓取
   - 验证抓取统计更新
   - 测试错误处理

4. **启用/禁用**:
   - 禁用数据源
   - 验证无法抓取
   - 重新启用

5. **删除数据源**:
   - 删除数据源
   - 验证数据清除

### 边界测试
- URL格式验证
- 抓取间隔范围（1-168小时）
- JSON配置格式验证
- 并发抓取测试

## 相关文件

### 后端文件
- `backend/src/main/java/com/dataelf/platform/entity/DataSource.java`
- `backend/src/main/java/com/dataelf/platform/dto/DataSourceDTO.java`
- `backend/src/main/java/com/dataelf/platform/dto/DataSourceCreateRequest.java`
- `backend/src/main/java/com/dataelf/platform/dto/DataSourceUpdateRequest.java`
- `backend/src/main/java/com/dataelf/platform/service/DataSourceService.java`
- `backend/src/main/java/com/dataelf/platform/controller/DataSourceController.java`
- `backend/src/main/java/com/dataelf/platform/repository/DataSourceRepository.java`

### 前端文件
- `frontend/src/api/dataSource.js` (新增)
- `frontend/src/views/admin/DataSourceManagement.vue` (新增)
- `frontend/src/router/index.js` (更新)
- `frontend/src/views/admin/AdminLayout.vue` (更新)

## 后续优化建议

### 功能增强
1. **实际抓取实现**: 集成爬虫框架（如Jsoup、Selenium）
2. **数据预览**: 抓取前预览数据
3. **批量导入**: 批量添加数据源
4. **数据去重**: 自动检测重复内容
5. **智能调度**: 根据更新频率动态调整间隔

### 性能优化
1. **异步抓取**: 使用消息队列处理抓取任务
2. **并发控制**: 限制同时抓取的数据源数量
3. **缓存机制**: 缓存抓取结果
4. **增量抓取**: 只抓取新增内容

### 监控告警
1. **抓取监控**: 实时监控抓取状态
2. **失败告警**: 抓取失败时发送通知
3. **性能统计**: 统计抓取耗时、成功率
4. **日志记录**: 详细的抓取日志

## 使用场景

### 1. 新闻聚合
从多个新闻网站抓取最新新闻，自动发布到平台。

### 2. 博客同步
同步多个技术博客的文章，建立技术文章库。

### 3. 数据采集
定期采集行业数据，进行分析和展示。

### 4. 内容监控
监控竞品网站内容更新，及时获取信息。

## 注意事项

### 1. 法律合规
- 遵守robots.txt规则
- 尊重网站版权
- 不抓取敏感信息

### 2. 技术规范
- 控制抓取频率
- 设置User-Agent
- 处理反爬虫机制

### 3. 数据质量
- 验证数据完整性
- 清洗无效数据
- 去重处理

## 总结

数据源管理系统已完整实现，提供了完善的数据源配置和管理功能。系统支持多种数据源类型、灵活的抓取配置、详细的统计信息，为自动化内容采集提供了基础设施。

**关键特性**:
- ✅ 多种数据源类型支持
- ✅ 灵活的抓取配置
- ✅ 完整的状态管理
- ✅ 详细的统计信息
- ✅ 高级配置选项
- ✅ 手动触发功能

**技术亮点**:
- 模块化设计
- 状态机管理
- JSON配置灵活性
- 完整的错误追踪
- 可扩展架构
