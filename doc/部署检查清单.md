# 数流精灵 - 部署检查清单

## 部署前准备

### 1. 环境要求检查

#### 后端环境
- [ ] Java 17+ 已安装
- [ ] Maven 3.8+ 已安装
- [ ] MySQL 5.7+ 已安装并运行
- [ ] Redis 6+ 已安装并运行
- [ ] RabbitMQ 3.9+ 已安装并运行

#### 前端环境
- [ ] Node.js 18+ 已安装
- [ ] npm 或 yarn 已安装

### 2. 数据库准备

#### 创建数据库
```sql
CREATE DATABASE ai_data_platform CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

#### 创建数据库用户
```sql
CREATE USER 'dataelf'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON ai_data_platform.* TO 'dataelf'@'localhost';
FLUSH PRIVILEGES;
```

#### 验证连接
```bash
mysql -u dataelf -p ai_data_platform
```

### 3. 配置文件检查

#### 后端配置 (application.yml)
- [ ] 数据库连接信息
  ```yaml
  spring:
    datasource:
      url: jdbc:mysql://localhost:3306/ai_data_platform
      username: dataelf
      password: your_password
  ```

- [ ] Redis配置
  ```yaml
  spring:
    redis:
      host: localhost
      port: 6379
      password: your_redis_password
  ```

- [ ] RabbitMQ配置
  ```yaml
  spring:
    rabbitmq:
      host: localhost
      port: 5672
      username: admin
      password: your_rabbitmq_password
  ```

- [ ] JWT密钥配置
  ```yaml
  jwt:
    secret: your_jwt_secret_key_at_least_256_bits
    expiration: 86400000
  ```

- [ ] 邮件服务配置
  ```yaml
  spring:
    mail:
      host: smtp.example.com
      port: 587
      username: your_email@example.com
      password: your_email_password
  ```

#### 前端配置 (.env)
- [ ] API地址配置
  ```env
  VITE_API_BASE_URL=http://localhost:8080
  ```

### 4. 文件上传目录

- [ ] 创建上传目录
  ```bash
  mkdir -p uploads/system
  chmod 755 uploads
  ```

- [ ] 验证目录权限
  ```bash
  ls -la uploads/
  ```

### 5. 静态资源

- [ ] robots.txt 文件存在
  - 位置: `backend/src/main/resources/static/robots.txt`
  - 验证: 启动后访问 `http://localhost:8080/robots.txt`

---

## 构建和部署

### 方式一：Docker Compose（推荐）

#### 1. 构建镜像
```bash
docker-compose build
```

#### 2. 启动所有服务
```bash
docker-compose up -d
```

#### 3. 查看日志
```bash
docker-compose logs -f backend
docker-compose logs -f frontend
```

#### 4. 验证服务
- [ ] 后端健康检查: `http://localhost:8080/actuator/health`
- [ ] 前端访问: `http://localhost`
- [ ] API文档: `http://localhost:8080/swagger-ui.html`
- [ ] RabbitMQ管理: `http://localhost:15672`

### 方式二：本地开发模式

#### 1. 启动依赖服务
```bash
docker-compose up -d mysql redis rabbitmq
```

#### 2. 启动后端
```bash
cd backend
mvn clean install
mvn spring-boot:run -Dspring-boot.run.profiles=dev
```

#### 3. 启动前端
```bash
cd frontend
npm install
npm run dev
```

#### 4. 验证服务
- [ ] 后端: `http://localhost:8080`
- [ ] 前端: `http://localhost:5173`

---

## 功能验证

### 1. 基础功能

#### 用户注册和登录
- [ ] 访问注册页面 `/register`
- [ ] 填写邮箱、手机、密码
- [ ] 提交注册
- [ ] 验证收到审核提示
- [ ] 管理员审核通过
- [ ] 验证收到审核通过邮件
- [ ] 使用账号登录

#### 内容创建
- [ ] 登录后点击"创建内容"
- [ ] 选择模板
- [ ] 填写内容字段
- [ ] 保存草稿
- [ ] 提交审核
- [ ] 验证收到提交成功提示

#### 内容审核
- [ ] 管理员登录
- [ ] 进入"内容审核"页面
- [ ] 查看待审核内容
- [ ] 批准内容
- [ ] 验证用户收到审核通过通知

#### 内容发布
- [ ] 用户查看已批准的内容
- [ ] 点击"发布"
- [ ] 验证内容出现在首页

### 2. 新功能验证

#### Logo上传
- [ ] 管理员进入"系统设置"
- [ ] 切换到"Logo设置"标签页
- [ ] 上传Logo图片（JPG/PNG）
- [ ] 验证上传成功
- [ ] 刷新首页
- [ ] 验证Logo显示正确

#### 系统配置
- [ ] 进入"基本设置"标签页
- [ ] 修改网站名称
- [ ] 修改首页标题和副标题
- [ ] 保存设置
- [ ] 刷新首页验证更改生效

#### 我的内容
- [ ] 用户点击"我的内容"
- [ ] 查看"全部"标签页
- [ ] 切换到"草稿"标签页
- [ ] 切换到"待审核"标签页
- [ ] 切换到"已发布"标签页
- [ ] 编辑一个草稿
- [ ] 删除一个草稿

#### 评论功能
- [ ] 访问已发布的内容详情页
- [ ] 滚动到评论区
- [ ] 未登录状态查看评论
- [ ] 登录后发表评论
- [ ] 验证评论显示在列表中
- [ ] 测试评论分页

#### SEO和robots.txt
- [ ] 访问 `http://localhost:8080/robots.txt`
- [ ] 验证内容正确
- [ ] 访问 `http://localhost:8080/api/ai/data/1`
- [ ] 验证返回JSON-LD格式数据

### 3. 导出功能

#### 多格式导出
- [ ] 打开内容详情页
- [ ] 点击"导出"按钮
- [ ] 选择JSON-LD格式导出
- [ ] 选择HTML格式导出
- [ ] 选择Markdown格式导出
- [ ] 验证文件下载成功

### 4. 通知系统

#### 站内通知
- [ ] 点击通知图标
- [ ] 查看未读通知
- [ ] 点击通知标记为已读
- [ ] 查看所有通知

#### 邮件通知
- [ ] 验证注册审核邮件
- [ ] 验证内容审核邮件
- [ ] 验证账号过期提醒邮件

---

## 性能测试

### 1. 响应时间
- [ ] API响应时间 < 200ms (P95)
- [ ] 页面首次内容绘制 < 1.5s
- [ ] 页面完全加载 < 3s

### 2. 并发测试
- [ ] 使用JMeter或Apache Bench测试
- [ ] 100并发用户
- [ ] 1000并发用户
- [ ] 验证系统稳定性

### 3. 缓存验证
- [ ] 验证Redis缓存命中率
- [ ] 验证静态资源缓存
- [ ] 验证API响应缓存

---

## 安全检查

### 1. 认证和授权
- [ ] 未登录访问受保护页面被重定向
- [ ] 普通用户无法访问管理后台
- [ ] JWT令牌过期后需要重新登录
- [ ] 登录失败5次后账号锁定15分钟

### 2. 输入验证
- [ ] SQL注入防护测试
- [ ] XSS攻击防护测试
- [ ] 文件上传安全测试
- [ ] 表单验证测试

### 3. HTTPS配置（生产环境）
- [ ] SSL证书已安装
- [ ] 强制HTTPS重定向
- [ ] HSTS头已配置
- [ ] 安全Cookie设置

---

## 监控和日志

### 1. 日志检查
- [ ] 应用日志正常输出
  ```bash
  tail -f backend/logs/ai-data-platform.log
  ```

- [ ] 错误日志检查
  ```bash
  tail -f backend/logs/ai-data-platform-error.log
  ```

- [ ] 审计日志检查
  ```bash
  tail -f backend/logs/ai-data-platform-audit.log
  ```

### 2. 健康检查
- [ ] Spring Boot Actuator
  ```bash
  curl http://localhost:8080/actuator/health
  ```

- [ ] Prometheus指标
  ```bash
  curl http://localhost:8080/actuator/prometheus
  ```

### 3. 数据库监控
- [ ] 连接池状态
- [ ] 慢查询日志
- [ ] 数据库大小

### 4. Redis监控
- [ ] 内存使用情况
- [ ] 缓存命中率
- [ ] 连接数

---

## 备份策略

### 1. 数据库备份
- [ ] 配置自动备份脚本
  ```bash
  mysqldump -u dataelf -p ai_data_platform > backup_$(date +%Y%m%d).sql
  ```

- [ ] 测试备份恢复
  ```bash
  mysql -u dataelf -p ai_data_platform < backup_20241220.sql
  ```

### 2. 文件备份
- [ ] 上传文件目录备份
  ```bash
  tar -czf uploads_backup_$(date +%Y%m%d).tar.gz uploads/
  ```

### 3. 配置文件备份
- [ ] 备份所有配置文件
- [ ] 版本控制管理

---

## 故障排查

### 常见问题

#### 1. 后端无法启动
**症状**: Spring Boot启动失败

**检查步骤**:
1. 查看日志: `tail -f backend/logs/ai-data-platform.log`
2. 检查MySQL连接: `mysql -u dataelf -p`
3. 检查Redis连接: `redis-cli ping`
4. 检查RabbitMQ连接: `rabbitmqctl status`
5. 检查端口占用: `lsof -i :8080`

#### 2. 前端无法访问
**症状**: 页面无法加载

**检查步骤**:
1. 检查前端服务状态
2. 检查API地址配置
3. 查看浏览器控制台错误
4. 检查CORS配置

#### 3. 文件上传失败
**症状**: Logo上传失败

**检查步骤**:
1. 检查上传目录权限: `ls -la uploads/`
2. 检查文件大小限制
3. 检查文件类型限制
4. 查看后端日志

#### 4. 邮件发送失败
**症状**: 用户未收到通知邮件

**检查步骤**:
1. 检查邮件服务配置
2. 测试SMTP连接
3. 查看RabbitMQ队列
4. 检查邮件日志

#### 5. 评论无法显示
**症状**: 评论列表为空

**检查步骤**:
1. 检查数据库comments表
2. 检查API响应
3. 查看浏览器控制台
4. 检查认证状态

---

## 生产环境额外检查

### 1. 域名和SSL
- [ ] 域名已解析
- [ ] SSL证书已安装
- [ ] HTTPS强制重定向
- [ ] 证书自动续期配置

### 2. 反向代理（Nginx）
- [ ] Nginx配置正确
- [ ] 负载均衡配置
- [ ] 静态资源缓存
- [ ] Gzip压缩启用

### 3. 防火墙
- [ ] 只开放必要端口（80, 443）
- [ ] 数据库端口不对外开放
- [ ] Redis端口不对外开放
- [ ] RabbitMQ管理端口限制访问

### 4. 资源限制
- [ ] JVM内存配置
- [ ] 数据库连接池大小
- [ ] Redis最大内存
- [ ] 文件上传大小限制

### 5. 监控告警
- [ ] 配置监控系统（Prometheus + Grafana）
- [ ] 设置告警规则
- [ ] 配置告警通知（邮件/短信）
- [ ] 定期检查监控数据

---

## 部署完成确认

### 最终检查清单
- [ ] 所有服务正常运行
- [ ] 所有功能测试通过
- [ ] 性能指标达标
- [ ] 安全检查通过
- [ ] 监控和日志正常
- [ ] 备份策略已实施
- [ ] 文档已更新
- [ ] 团队已培训

### 上线准备
- [ ] 制定上线计划
- [ ] 准备回滚方案
- [ ] 通知相关人员
- [ ] 准备应急联系方式

---

## 维护计划

### 日常维护
- [ ] 每日检查日志
- [ ] 每日检查监控数据
- [ ] 每周数据库备份验证
- [ ] 每月安全更新

### 定期优化
- [ ] 数据库索引优化
- [ ] 缓存策略调整
- [ ] 代码性能优化
- [ ] 用户反馈收集

---

**检查人员**: _______________
**检查日期**: _______________
**部署环境**: [ ] 开发 [ ] 测试 [ ] 生产
**部署状态**: [ ] 通过 [ ] 未通过

**备注**:
_______________________________________________
_______________________________________________
_______________________________________________
